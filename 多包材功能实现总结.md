# 多包材功能实现总结

## 功能概述

本次更新实现了商品和组合商品的多包材支持，包括：

1. **商品多包材支持**：每个商品可以关联多种包材，并指定各自的用量
2. **组合商品多包材支持**：组合商品可以有自己的包材，基础商品的包材也会被继承
3. **库存管理优化**：打包和组装功能适配多包材逻辑，精确计算包材消耗
4. **向后兼容**：保留原有的单包材字段，确保系统平滑升级

## 数据库变更

### 新增表结构

#### 1. 商品包材关联表 (product_packaging_relations)
```sql
CREATE TABLE product_packaging_relations (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    packaging_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,  -- 每个商品需要的包材数量
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(product_id, packaging_id)
);
```

#### 2. 组合商品包材关联表 (combo_product_packaging_relations)
```sql
CREATE TABLE combo_product_packaging_relations (
    id SERIAL PRIMARY KEY,
    combo_product_id INTEGER NOT NULL REFERENCES combo_products(id) ON DELETE CASCADE,
    packaging_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,  -- 每个组合商品需要的包材数量
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(combo_product_id, packaging_id)
);
```

## 数据迁移步骤

### 第一步：执行数据库迁移

```bash
# 进入后端目录
cd backend

# 执行迁移，创建新的关联表
alembic upgrade c47e8b9f2a1d

# 执行数据迁移，将现有包材数据迁移到新表
alembic upgrade d58f9c3e4b2a
```

### 第二步：验证数据迁移

执行以下SQL查询验证数据迁移是否成功：

```sql
-- 检查商品包材关系迁移
SELECT p.name as product_name, p.sku, pkg.name as packaging_name, ppr.quantity
FROM product_packaging_relations ppr
JOIN products p ON ppr.product_id = p.id
JOIN products pkg ON ppr.packaging_id = pkg.id
ORDER BY p.name;

-- 检查组合商品包材关系迁移  
SELECT cp.name as combo_name, cp.sku, pkg.name as packaging_name, cppr.quantity
FROM combo_product_packaging_relations cppr
JOIN combo_products cp ON cppr.combo_product_id = cp.id
JOIN products pkg ON cppr.packaging_id = pkg.id
ORDER BY cp.name;
```

### 第三步：清理旧字段（可选，建议在确认系统运行正常后执行）

创建清理迁移文件：

```sql
-- 删除products表的packaging_id字段
ALTER TABLE products DROP COLUMN packaging_id;

-- 删除combo_products表的packaging_id字段  
ALTER TABLE combo_products DROP COLUMN packaging_id;
```

## 功能特性

### 1. 商品管理

- **创建商品**：可以选择多种包材并设置用量
- **编辑商品**：可以修改包材关系
- **包材消耗**：打包时会按比例消耗多种包材

### 2. 组合商品管理

- **创建组合商品**：支持设置组合商品本身的包材
- **基础商品包材继承**：自动继承基础商品的包材需求
- **编辑功能**：支持修改组合商品和基础商品的包材关系

### 3. 库存管理

- **打包功能**：支持多包材同时消耗，会检查所有包材库存是否充足
- **组装功能**：计算基础商品包材+组合商品包材的总消耗
- **库存计算**：可组合数量基于所有资源（基础商品、各种包材）的最小值

### 4. 向后兼容

- 保留原有的`packaging_id`字段作为向后兼容
- API同时支持新旧两种数据格式
- 库存计算逻辑会优先使用新的多包材关系，如果没有则使用旧的单包材关系

## API变更

### 商品API

#### 创建商品
```json
POST /api/v1/products/
{
  "name": "商品A",
  "sku": "PROD001", 
  "sale_type": "商品",
  "warehouse_id": 1,
  "packaging_relations": [
    {
      "packaging_id": 5,
      "quantity": 2
    },
    {
      "packaging_id": 6, 
      "quantity": 1
    }
  ]
}
```

#### 更新商品
```json
PUT /api/v1/products/1
{
  "name": "商品A（更新）",
  "packaging_relations": [
    {
      "packaging_id": 5,
      "quantity": 3
    }
  ]
}
```

### 组合商品API

#### 创建组合商品
```json
POST /api/v1/combo-products/
{
  "name": "组合商品A",
  "sku": "COMBO001",
  "warehouse_id": 1,
  "combo_items": [
    {
      "base_product_id": 1,
      "quantity": 2
    }
  ],
  "packaging_relations": [
    {
      "packaging_id": 7,
      "quantity": 1
    }
  ]
}
```

## 测试建议

1. **功能测试**
   - 测试商品的多包材创建和编辑
   - 测试组合商品的多包材创建和编辑
   - 测试库存打包和组装功能

2. **数据一致性测试**
   - 验证迁移后的数据完整性
   - 测试新旧API的兼容性
   - 验证库存计算的准确性

3. **性能测试**
   - 测试多包材查询的性能
   - 测试复杂组合商品的组装性能

## 注意事项

1. **数据备份**：执行迁移前请备份数据库
2. **分批迁移**：如果数据量大，建议分批执行迁移
3. **监控日志**：迁移期间注意监控应用日志
4. **用户通知**：建议在维护时段执行迁移，并提前通知用户

## 组合商品基础商品包材自定义功能

### 新增功能特性

**组合商品中基础商品包材自定义**：
- 每个基础商品在不同组合商品中可以有不同的包材配置
- 创建组合商品时，选择基础商品后会预填充其默认包材配置
- 用户可以自由修改基础商品在当前组合中使用的包材
- 支持完全自定义包材配置，不受基础商品默认配置限制

### 数据库表结构

#### 新增表：组合商品项目包材关系表 (combo_item_packaging_relations)
```sql
CREATE TABLE combo_item_packaging_relations (
    id SERIAL PRIMARY KEY,
    combo_product_item_id INTEGER NOT NULL REFERENCES combo_product_items(id) ON DELETE CASCADE,
    packaging_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(combo_product_item_id, packaging_id)
);
```

### API变更

#### 新增端点
```
GET /api/v1/products/{product_id}/packaging-relations
```
用于获取商品的默认包材配置，前端创建组合商品时用于预填充。

#### 组合商品API数据格式
```json
{
  "name": "组合商品A",
  "sku": "COMBO001",
  "warehouse_id": 1,
  "combo_items": [
    {
      "base_product_id": 1,
      "quantity": 2,
      "packaging_relations": [
        {
          "packaging_id": 5,
          "quantity": 1
        },
        {
          "packaging_id": 6,
          "quantity": 2
        }
      ]
    }
  ],
  "packaging_relations": [
    {
      "packaging_id": 7,
      "quantity": 1
    }
  ]
}
```

### 业务逻辑优化

**库存计算逻辑**：
- 组装组合商品时，使用保存在组合商品中的基础商品包材配置
- 不再依赖基础商品的默认包材配置
- 可组合数量计算基于组合商品中实际配置的包材需求

**前端交互流程**：
1. 选择基础商品后，自动获取其默认包材配置
2. 在多选框中预填充默认包材，用户可以修改
3. 保存时存储用户实际选择的包材配置
4. 编辑时显示已保存的包材配置

### 数据迁移

执行以下迁移：
```bash
cd backend
alembic upgrade e92f8d7a5c1b  # 创建组合商品项目包材关系表
```

## 后续工作

1. 前端界面适配（商品和组合商品表单支持多包材选择）
2. 数据分析和报表功能优化
3. 性能优化和索引优化
4. 用户培训和文档更新
