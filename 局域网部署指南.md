# 局域网部署指南

## 问题原因
您的系统在局域网部署后无法登录，主要原因是**CORS跨域配置**问题：
- 前端运行在：`192.168.31.188:3000`
- 后端运行在：`192.168.31.188:8000`
- 原CORS配置只允许localhost访问

## 已修复的问题

### 1. 后端CORS配置已更新
在 `backend/app/core/config.py` 中，已添加您的局域网IP地址到CORS允许列表。

### 2. 前端API配置已修复
**重要更新**：修复了其他局域网设备无法访问的问题
- 在 `frontend/lib/api.ts` 中，API地址现在固定指向部署机器的IP地址
- 创建了 `frontend/config/api-config.ts` 配置文件，便于管理IP地址
- 解决了其他设备访问时 `localhost` 指向错误的问题

## 部署步骤

### 1. 配置后端IP地址
如果您的部署机器IP地址不是 `192.168.31.188`，请修改：

**方法一：修改配置文件**
编辑 `frontend/config/api-config.ts`：
```typescript
export const BACKEND_HOST = '您的实际IP地址'  // 例如：'192.168.1.100'
```

**方法二：使用环境变量**
在 `frontend/` 目录下创建 `.env.local` 文件：
```bash
NEXT_PUBLIC_API_URL=http://192.168.31.188:8000
```

### 2. 重启服务

#### 重启后端：
```bash
cd backend
# 如果使用虚拟环境，先激活
python main.py
# 或使用uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

#### 重启前端：
```bash
cd frontend
npm run dev -- --host 0.0.0.0 --port 3000
```

### 3. 确认服务监听地址

确保服务绑定到所有网络接口（0.0.0.0），而不仅仅是localhost：

- **后端**: 应该监听 `0.0.0.0:8000`
- **前端**: 应该监听 `0.0.0.0:3000`

## 测试步骤

1. **测试后端API**：
   ```bash
   curl http://192.168.31.188:8000/health
   ```
   应该返回：`{"status": "healthy"}`

2. **测试前端访问**：
   浏览器访问：`http://192.168.31.188:3000`

3. **测试登录功能**：
   使用管理员账号登录测试

## 故障排除

### 如果仍然无法访问：

1. **检查防火墙**：
   ```bash
   # Windows - 允许端口
   netsh advfirewall firewall add rule name="ERP Backend" dir=in action=allow protocol=TCP localport=8000
   netsh advfirewall firewall add rule name="ERP Frontend" dir=in action=allow protocol=TCP localport=3000
   ```

2. **检查端口占用**：
   ```bash
   netstat -an | findstr :8000
   netstat -an | findstr :3000
   ```

3. **检查服务绑定地址**：
   确保服务启动时显示绑定到 `0.0.0.0:端口` 而不是 `127.0.0.1:端口`

### 常见启动命令：

#### 后端启动（绑定所有接口）：
```bash
cd backend
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

#### 前端启动（绑定所有接口）：
```bash
cd frontend
npm run dev -- --hostname 0.0.0.0 --port 3000
```

## 生产环境建议

在生产环境中，建议：

1. **移除CORS中的通配符**：
   将 `"*"` 从CORS配置中移除，只保留具体的域名

2. **使用HTTPS**：
   配置SSL证书，使用HTTPS协议

3. **使用反向代理**：
   使用Nginx或Apache作为反向代理

4. **环境变量管理**：
   使用更安全的方式管理敏感配置信息

## 当前配置摘要

- **前端**: `http://192.168.31.188:3000`
- **后端**: `http://192.168.31.188:8000`
- **CORS**: 已允许您的局域网IP
- **API配置**: 前端固定连接到部署机器的8000端口
- **多设备支持**: 局域网内任何设备都能正确访问

## 重要说明

现在系统已经修复了多设备访问问题：
- ✅ 部署机器可以正常访问
- ✅ 局域网内其他设备也可以正常访问
- ✅ 所有设备的前端都会正确连接到 `192.168.31.188:8000`
